name: Crawl and Push

on:
  workflow_call:
    inputs:
      year:
        description: "å­¸å¹´ï¼ˆæ°‘åœ‹å¹´ï¼‰"
        required: true
        type: string
        default: "114"
      term:
        description: "å­¸æœŸï¼ˆ1=ä¸Šå­¸æœŸ, 2=ä¸‹å­¸æœŸ, 3=æš‘æœŸï¼‰"
        required: true
        type: string
        default: "2"
  workflow_dispatch:
    inputs:
      year:
        description: "å­¸å¹´ï¼ˆæ°‘åœ‹å¹´ï¼‰"
        required: false
        default: "114"
      term:
        description: "å­¸æœŸï¼ˆ1=ä¸Šå­¸æœŸ, 2=ä¸‹å­¸æœŸ, 3=æš‘æœŸï¼‰"
        required: false
        default: "2"

jobs:
  crawl-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: pip install uv

      - name: Install crawler dependencies
        working-directory: crawler
        run: uv sync

      - name: Run crawler
        working-directory: crawler
        run: |
          YEAR=${{ inputs.year || github.event.inputs.year || '114' }}
          TERM=${{ inputs.term || github.event.inputs.term || '2' }}
          echo "ğŸ“¥ æŠ“å– ${YEAR}-${TERM} èª²ç¨‹è³‡æ–™"
          uv run main.py --year $YEAR --term $TERM

      - name: Generate Sitemap
        working-directory: crawler
        run: |
          YEAR=${{ inputs.year || github.event.inputs.year || '114' }}
          TERM=${{ inputs.term || github.event.inputs.term || '2' }}
          echo "ğŸ—ºï¸ ç”Ÿæˆ Sitemap.xml"
          uv run generate_sitemap.py --year $YEAR --term $TERM

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Commit and push data
        run: |
          YEAR=${{ inputs.year || github.event.inputs.year || '114' }}
          TERM=${{ inputs.term || github.event.inputs.term || '2' }}
          echo "ğŸ“¤ æäº¤ ${YEAR}-${TERM} èª²ç¨‹è³‡æ–™åˆ° GitHub"
          git add crawler/original_data/*
          git add public/*
          git commit -m "ğŸ± Update course data for ${YEAR}-${TERM}"

      - name: Notify success
        run: echo "ğŸ‰ æ¯é€±èª²ç¨‹è³‡æ–™æ›´æ–°æˆåŠŸï¼"
